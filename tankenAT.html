<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="js-widget-title" content="TankenAT" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg1: #ffffff;
      --bg2: #eeeeee;
      --bg3: #fafafa;
      --text: #000000;
      --muted: #666666;
      --accent: #2b8cff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg1: #111111;
        --bg2: #222222;
        --bg3: #212121;
        --text: #ededed;
        --muted: #bbbbbb;
        --accent: #4da3ff;
      }
    }
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
    }
    .app {
      display: flex;
      flex-direction: column;
      margin: 8px auto;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      max-width: 400px;
      padding: 10px;
    }
    .status { text-align: center; }
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 5px;
    }
    a.item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      color: inherit;
      background: var(--bg3);
      padding: 10px;
      border-radius: 10px;
      transition: background 0.2s;
    }
    a.item.big {
      flex-direction: column;
      align-items: center;
      padding: 14px;
    }
    .price { font-family: Menlo, monospace; font-size: 22px; }
    .smallPrice { font-family: Menlo, monospace; font-size: 12px; color: var(--muted); }
    .meta { text-align: center; }
    .name { font-weight: 600; }
    .addr { font-size: 12px; color: var(--muted); }
    .timestamp { font-size: 11px; color: var(--muted); text-align: center;}
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <div id="status" class="status"></div>
    <div id="time" class="timestamp"></div>
    <div id="list" class="list">
      <a class="item big" href="#action=copy0"><div class="price"></div><div class="meta"><div class="name"></div><div class="addr"></div></div></a>
      <a class="item" href="#action=copy1"><div class="smallPrice"></div><div style="flex:1;margin-left:18px;"><div class="name"></div><div class="addr"></div></div></a>
      <a class="item" href="#action=copy2"><div class="smallPrice"></div><div style="flex:1;margin-left:18px;"><div class="name"></div><div class="addr"></div></div></a>
      <a class="item" href="#action=copy3"><div class="smallPrice"></div><div style="flex:1;margin-left:18px;"><div class="name"></div><div class="addr"></div></div></a>
      <a class="item" href="#action=copy4"><div class="smallPrice"></div><div style="flex:1;margin-left:18px;"><div class="name"></div><div class="addr"></div></div></a>
    </div>
  </div>

  <script>
    const FUEL_TYPE = 'DIE';
    const FALLBACK_LOCATION = { latitude: 48.290, longitude: 14.285 };
    const CACHE_KEY = "stations_cache_v1";
    const CACHE_DAYS = 1;

    const el = id => document.getElementById(id);
    const items = Array.from(document.querySelectorAll('#list .item'));
    let latestStations = [];

    /* ----- Cookie helpers ----- */
    function setCookie(c_name, value, exdays) {
      var exdate = new Date();
      exdate.setDate(exdate.getDate() + exdays);
      var c_value = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString());
      document.cookie = c_name + "=" + c_value + "; path=/";
    }

    function getCookie(c_name) {
      var i, x, y, ARRcookies = document.cookie.split(";");
      for (i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if (x == c_name) return unescape(y);
      }
    }

    /* ----- Helpers ----- */
    function formatValue(value) {
      if (value == null) return "--";
      const str = String(value).trim();
      return str ? str + 'â‚¬' : "--";
    }

    function showStatus(msg) { el('status').textContent = msg || ''; }

    function formatFullAddress(loc) {
      if (!loc) return 'Keine Adresse';
      const { address = '', postalCode = '', city = '' } = loc;
      return [address, postalCode, city].filter(Boolean).join(', ');
    }

    function renderStations(data) {
      latestStations = data.filter(function(s) {
        return Array.isArray(s.prices) && s.prices.length > 0;
      });

      if (latestStations.length === 0) {
        showStatus('Keine Stationen gefunden.');
        items.forEach(it => it.classList.add('hidden'));
      } else {
        showStatus('');
        const top = latestStations.slice(0, items.length);
        items.forEach(function(item, i) {
          var st = top[i];
          if (!st) {
            item.classList.add('hidden');
            return;
          }
          item.classList.remove('hidden');
          var price = st.prices && st.prices[0] ? st.prices[0].amount : null;
          var addr = formatFullAddress(st.location);
          if (i === 0) {
            item.querySelector('.price').textContent = formatValue(price);
            item.querySelector('.name').textContent = st.name || 'Kein Name';
            item.querySelector('.addr').textContent = addr;
          } else {
            item.querySelector('.smallPrice').textContent = formatValue(price);
            item.querySelector('.name').textContent = st.name || 'Kein Name';
            item.querySelector('.addr').textContent = addr;
          }
        });
      }

      var now = new Date();
      el('time').textContent =
        now.toLocaleDateString('de-AT') + ' ' +
        now.toLocaleTimeString('de-AT', { hour: '2-digit', minute: '2-digit' });
    }

    /* ----- Clipboard ----- */
    function copyAddress(index) {
      var station = latestStations[index];
      if (!station || !station.location) return;
      var loc = station.location;
      var text = [loc.address || '', loc.postalCode || '', loc.city || ''].filter(Boolean).join(', ');
      navigator.clipboard.writeText(text).catch(function(e) { console.warn('Clipboard error', e); });
    }

    function handleHashAction() {
      var qs = window.location.hash;
      if (qs.startsWith('#')) qs = qs.substring(1);
      var params = new URLSearchParams(qs);
      var act = params.get('action');
      if (act && act.startsWith('copy')) {
        var idx = parseInt(act.substring(4), 10);
        if (!isNaN(idx)) copyAddress(idx);
      }
    }

    /* ----- Load cached data immediately ----- */
    (function loadCached() {
      try {
        var cached = getCookie(CACHE_KEY);
        if (cached) {
          var parsed = JSON.parse(cached);
          renderStations(parsed);
        } else {
          showStatus('Lade gespeicherte Daten...');
        }
      } catch (e) {
        console.warn('Cache error', e);
      }
    })();

    /* ----- Load fresh stations (no async/await) ----- */
    function loadStations() {
      var lat = FALLBACK_LOCATION.latitude;
      var lon = FALLBACK_LOCATION.longitude;
      var fallback = false;

      // get geolocation
      try {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(pos) {
            lat = pos.coords.latitude.toFixed(3);
            lon = pos.coords.longitude.toFixed(3);
            requestStations(lat, lon);
          }, function() {
            fallback = true;
            showStatus('Der Standardstandort wird verwendet.');
            requestStations(lat, lon);
          }, { maximumAge: 60000, timeout: 10000 });
        } else {
          fallback = true;
          requestStations(lat, lon);
        }
      } catch (e) {
        fallback = true;
        requestStations(lat, lon);
      }
    }

    function requestStations(lat, lon) {
      var url = "https://api.e-control.at/sprit/1.0/search/gas-stations/by-address?latitude=" +
        lat + "&longitude=" + lon + "&fuelType=" + FUEL_TYPE + "&includeClosed=false";

      fetch(url)
        .then(function(resp) {
          if (!resp.ok) throw new Error('API Error');
          return resp.json();
        })
        .then(function(json) {
          renderStations(json);
          setCookie(CACHE_KEY, JSON.stringify(json), CACHE_DAYS);
        })
        .catch(function(e) {
          console.error(e);
          showStatus('Fehler beim Laden der Tankstellen.');
        });
    }

    handleHashAction();
    loadStations();

    function __wweb2JsWidgetTitle() { return "TankenAT"; }
  </script>
</body>
</html>
