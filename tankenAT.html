<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta  name="js-widget-title" content="TankenAT">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg1: #ffffff;
      --bg2: #eeeeee;
      --bg3: #fafafa;
      --text: #000000;
      --muted: #666666;
      --accent: #2b8cff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg1: #111111;
        --bg2: #222222;
        --bg3: #212121;
        --text: #ededed;
        --muted: #bbbbbb;
        --accent: #4da3ff;
      }
    }

    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
    }

    .app {
      max-width: 80%;
      display: flex;
      flex-direction: column;
      margin: 18px auto;
      padding: 14px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    .status {
      text-align: center;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 25px;
    }

    a.item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      color: inherit;
      background: var(--bg3);
      padding: 10px;
      border-radius: 10px;
      transition: background 0.2s;
    }

    a.item:hover {
      background: rgba(0,0,0,0.08);
    }

    a.item.big {
      flex-direction: column;
      align-items: center;
      padding: 14px;
    }

    .price {
      font-family: Menlo, monospace;
      font-size: 22px;
    }

    .smallPrice {
      font-family: Menlo, monospace;
      font-size: 12px;
      color: var(--muted);
    }

    .meta {
      text-align: center;
    }

    .name {
      font-weight: 600;
    }

    .addr {
      font-size: 12px;
      color: var(--muted);
    }

    .timestamp {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 18px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="status" class="status"></div>
    <div id="list" class="list" aria-live="polite"></div>
    <div id="time" class="timestamp"></div>
  </div>

  <script>
    /* ---------------- Constants ---------------- */
    const FUEL_TYPE = 'DIE';
    const FALLBACK_LOCATION = { latitude: 48.290, longitude: 14.285 };
    const el = id => document.getElementById(id);
    let latestStations = [];

    /* ---------------- Helper Functions ---------------- */
    function formatValue(value) {
      if (value == null) return "--";
      const str = String(value).trim();
      return str ? str + 'â‚¬' : "--";
    }

    function showStatus(msg) {
      el('status').textContent = msg || '';
    }

    function formatFullAddress(location) {
      if (!location) return 'Keine Adresse';
      const { address = '', postalCode = '', city = '' } = location;
      return [address, postalCode, city].filter(Boolean).join(', ');
    }

    async function copyAddressAndRefresh(station) {
      if (station?.location) {
        const { address = '', city = '', postalCode = '' } = station.location;
        const textToCopy = [address, postalCode, city].filter(Boolean).join(', ');
        try {
          await navigator.clipboard.writeText(textToCopy);
        } catch(e) {
          console.warn('Clipboard error', e);
        }
      }
    }

    /* ---------------- Render ---------------- */
    function renderStations(data) {
      latestStations = data;
      const list = el('list');
      list.innerHTML = '';

      if (!Array.isArray(data) || data.length === 0) {
        showStatus('Keine Stationen gefunden.');
        return;
      }

      const stations = data.filter(s => Array.isArray(s.prices) && s.prices.length > 0);
      const top = stations.slice(0, 5);

      top.forEach((station, i) => {
        const price = station.prices?.[0]?.amount ?? null;
        const fullAddress = formatFullAddress(station.location);
        const item = document.createElement('a');
        item.href = `#action=copyAddressAndRefresh&index=${i}`;
        item.className = i === 0 ? 'item big' : 'item';
        item.onclick = e => { e.preventDefault(); handleAction('copyAddressAndRefresh', i); };

        if (i === 0) {
          item.innerHTML = `
            <div class="price">${formatValue(price)}</div>
            <div class="meta">
              <div class="name">${station.name || 'Kein Name'}</div>
              <div class="addr">${fullAddress}</div>
            </div>`;
        } else {
          item.innerHTML = `
            <div class="smallPrice">${formatValue(price)}</div>
            <div style="flex:1; margin-left:18px;">
              <div class="name">${station.name || 'Kein Name'}</div>
              <div class="addr">${fullAddress}</div>
            </div>`;
        }

        list.appendChild(item);
      });

      const now = new Date();
      el('time').textContent =
        now.toLocaleDateString('de-AT') + ' ' +
        now.toLocaleTimeString('de-AT', {hour:'2-digit', minute:'2-digit'});
    }

    /* ---------------- Action Handling ---------------- */
    function handleAction(action, index) {
      switch (action) {
        case 'copyAddressAndRefresh':
          if (latestStations[index]) copyAddressAndRefresh(latestStations[index]);
          break;
      }
    }

    /* ---------------- Hash Action Processor ---------------- */
    (function processWidgetActions() {
      let queryString = window.location.hash;
      if (queryString.startsWith("#")) queryString = queryString.substring(1);
      const urlParams = new URLSearchParams(queryString);
      const actionParam = urlParams.get('action');
      const index = parseInt(urlParams.get('index') || "0", 10);
      if (actionParam) handleAction(actionParam, index);
    })();

    /* ---------------- Widget Ready ---------------- */
    function __wweb2WaitMillisecondsToWidgetIsReady(currentDelayMs) {
      return 3000;
    }

    /* ---------------- API Fetch ---------------- */
    async function loadStations() {
      let lat = FALLBACK_LOCATION.latitude;
      let lon = FALLBACK_LOCATION.longitude;
      let fallbackUsed = false;

      try {
        const pos = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) return reject();
          navigator.geolocation.getCurrentPosition(resolve, reject, { maximumAge: 60000, timeout: 10000 });
        });

        if (pos?.coords) {
          lat = pos.coords.latitude.toFixed(3);
          lon = pos.coords.longitude.toFixed(3);
        } else fallbackUsed = true;
      } catch {
        fallbackUsed = true;
      }

      if (fallbackUsed)
        showStatus('Der Standardstandort wird verwendet.');
      else
        showStatus('');

      try {
        const apiURL = `https://api.e-control.at/sprit/1.0/search/gas-stations/by-address?latitude=${lat}&longitude=${lon}&fuelType=${FUEL_TYPE}&includeClosed=false`;
        const resp = await fetch(apiURL);
        if (!resp.ok) throw new Error('Fehler beim Laden der API');
        const data = await resp.json();
        showStatus('');
        renderStations(data);
      } catch(e) {
        console.error(e);
        showStatus('Fehler beim Laden der Tankstellen.');
      }
    }

    /* ---------------- Init ---------------- */
    loadStations();
  </script>
</body>
</html>
