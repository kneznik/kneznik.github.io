<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg1: #ffffff;
      --bg2: #eeeeee;
      --bg3: #fafafa;
      --text: #000000;
      --muted: #666666;
      --accent: #2b8cff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg1: #111111;
        --bg2: #222222;
        --bg3: #212121;
        --text: #ededed;
        --muted: #bbbbbb;
        --accent: #4da3ff;
      }
    }

    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
    }

    .app {
      max-width: 520px;
      margin: 18px auto;
      padding: 14px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    a.item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      color: inherit;
      background: var(--bg3);
      padding: 10px;
      border-radius: 10px;
      transition: background 0.2s;
    }

    a.item:hover {
      background: rgba(0,0,0,0.08);
    }

    a.item.big {
      flex-direction: column;
      align-items: center;
      padding: 14px;
    }

    .price {
      font-family: Menlo, monospace;
      font-size: 22px;
    }

    .smallPrice {
      font-family: Menlo, monospace;
      font-size: 12px;
      color: var(--muted);
    }

    .meta {
      text-align: center;
    }

    .name {
      font-weight: 600;
    }

    .addr {
      font-size: 12px;
      color: var(--muted);
    }

    .timestamp {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 8px;
    }

    .fallback-msg {
      font-size: 12px;
      color: var(--accent);
      text-align: center;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="status"></div>
    <div id="list" class="list" aria-live="polite"></div>
    <div id="fallbackMsg" class="fallback-msg"></div>
    <div id="time" class="timestamp"></div>
  </div>

  <script>
    /* ---------------- Constants ---------------- */
    const FUEL_TYPE = 'DIE';
    const FALLBACK_LOCATION = { latitude: 48.290, longitude: 14.285 };
    const el = id => document.getElementById(id);

    /* ---------------- Helper Functions ---------------- */
    function formatValue(value) {
      if (value == null) return "--";
      const str = String(value).trim();
      return str ? str + '€' : "--";
    }

    function showStatus(msg) {
      el('status').textContent = msg || '';
    }

    function setFallbackMsg(msg) {
      el('fallbackMsg').textContent = msg || '';
    }

    function formatFullAddress(location) {
      if (!location) return 'Keine Adresse';
      const { address = '', postalCode = '', city = '' } = location;
      return [address, postalCode, city].filter(Boolean).join(', ');
    }

    /* ---------------- Event Handlers ---------------- */
    async function copyAddressAndRefresh(station) {
      if (station?.location) {
        const { address = '', city = '', postalCode = '' } = station.location;
        const textToCopy = [address, postalCode, city].filter(Boolean).join(', ');
        try {
          await navigator.clipboard.writeText(textToCopy);
        } catch(e) {
          console.warn('Clipboard error', e);
        }
      }
      loadStations(); // reload widget silently
    }

    /* ---------------- Render Functions ---------------- */
    function renderStations(data) {
      const list = el('list');
      list.innerHTML = '';

      if (!Array.isArray(data) || data.length === 0) {
        showStatus('Keine Stationen gefunden.');
        return;
      }

      const stations = data.filter(s => Array.isArray(s.prices) && s.prices.length > 0);
      const top = stations.slice(0,3);

      top.forEach((station, i) => {
        const price = station.prices?.[0]?.amount ?? null;
        const fullAddress = formatFullAddress(station.location);

        const item = document.createElement('a');
        item.href = '#';
        item.className = i === 0 ? 'item big' : 'item';
        item.onclick = e => { e.preventDefault(); copyAddressAndRefresh(station); };

        if (i === 0) {
          const priceEl = document.createElement('div');
          priceEl.className = 'price';
          priceEl.textContent = formatValue(price);

          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.innerHTML = `
            <div class="name">${station.name || 'Kein Name'}</div>
            <div class="addr">${fullAddress}</div>
          `;

          item.appendChild(priceEl);
          item.appendChild(meta);
        } else {
          const priceEl = document.createElement('div');
          priceEl.className = 'smallPrice';
          priceEl.textContent = formatValue(price);

          const right = document.createElement('div');
          right.style.flex = '1';
          right.style.marginLeft = '8px';
          right.innerHTML = `
            <div class="name">${station.name || 'Kein Name'}</div>
            <div class="addr">${fullAddress}</div>
          `;

          item.appendChild(priceEl);
          item.appendChild(right);
        }

        list.appendChild(item);
      });

      const now = new Date();
      el('time').textContent =
        now.toLocaleDateString('de-AT') + ' ' +
        now.toLocaleTimeString('de-AT', {hour:'2-digit', minute:'2-digit'});
    }

    /* ---------------- API Fetch ---------------- */
    async function loadStations() {
      let lat = FALLBACK_LOCATION.latitude;
      let lon = FALLBACK_LOCATION.longitude;
      let fallbackUsed = false;

      try {
        const pos = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) return reject();
          navigator.geolocation.getCurrentPosition(resolve, reject, { maximumAge: 60000, timeout: 10000 });
        });

        if (pos?.coords) {
          lat = pos.coords.latitude.toFixed(3);
          lon = pos.coords.longitude.toFixed(3);
        } else {
          fallbackUsed = true;
        }
      } catch {
        fallbackUsed = true;
      }

      if (fallbackUsed) {
        setFallbackMsg('Der Standardstandort "Eichendorffstraße, Linz" wird verwendet.');
      } else {
        setFallbackMsg('');
      }

      try {
        const apiURL = `https://api.e-control.at/sprit/1.0/search/gas-stations/by-address?latitude=${lat}&longitude=${lon}&fuelType=${FUEL_TYPE}&includeClosed=false`;
        const resp = await fetch(apiURL);
        if (!resp.ok) throw new Error('Fehler beim Laden der API');
        const data = await resp.json();
        showStatus('');
        renderStations(data);
      } catch(e) {
        console.error(e);
        showStatus('Fehler beim Laden der Tankstellen.');
      }
    }

    /* ---------------- Initialization ---------------- */
    loadStations();
  </script>
</body>
</html>
