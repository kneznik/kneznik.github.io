<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="js-widget-title" content="TankenAT" />
  <style>
    :root {
      --text: #000;
      --muted: #666;
      font-family: Inter, system-ui, -apple-system;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --text: #ededed;
        --muted: #bbb;
      }
    }
    html, body {
      margin: 0;
      height: 100%;
      color: var(--text);
    }
    .app {
      display: flex;
      flex-direction: column;
      max-width: 400px;
      margin: 8px auto;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
      padding: 10px;
    }
    .status {
      text-align: center;
    }
    .timestamp {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 20px;
    }
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 5px;
    }
    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 10px;
      padding: 5px;
    }
    .item.big {
      flex-direction: column;
      align-items: center;
      padding: 7px;
    }
    .price {
      font-family: Menlo, monospace;
      font-size: 22px;
    }
    .smallPrice {
      font-family: Menlo, monospace;
      font-size: 12px;
      color: var(--muted);
    }
    .name {
      font-weight: 600;
    }
    .addr {
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="status" class="status"></div>
    <div id="list" class="list"></div>
    <div id="time" class="timestamp"></div>
  </div>

  <script>
    const FUEL_TYPE = 'DIE';
    const FALLBACK_LOCATION = { latitude: 48.265, longitude: 14.287 };
    const el = id => document.getElementById(id);

    const formatValue = v => v != null ? v + "€" : "--";
    const formatFullAddress = l => l ? [l.address, l.postalCode, l.city].filter(Boolean).join(', ') : '';
    const showStatus = msg => el('status').textContent = msg || '';

    function renderStations(data) {
      const listEl = el('list');
      listEl.innerHTML = ''; // Clear old content

      const stations = data?.filter(s => s.prices && s.prices.length);
      if (!stations?.length) {
        showStatus('Keine Daten verfügbar');
        return;
      }

      stations.slice(0, 5).forEach((st, i) => {
        const item = document.createElement('div');
        item.className = 'item' + (i === 0 ? ' big' : '');

        const priceEl = document.createElement('div');
        priceEl.className = i === 0 ? 'price' : 'smallPrice';
        priceEl.textContent = formatValue(st.prices[0].amount);

        const metaEl = document.createElement('div');
        metaEl.className = i === 0 ? 'meta' : '';
        metaEl.style.flex = i === 0 ? '' : '1';
        if (i !== 0) metaEl.style.marginLeft = '18px';

        const nameEl = document.createElement('div');
        nameEl.className = 'name';
        nameEl.textContent = st.name || 'Kein Name';

        const addrEl = document.createElement('div');
        addrEl.className = 'addr';
        addrEl.textContent = formatFullAddress(st.location);

        metaEl.appendChild(nameEl);
        metaEl.appendChild(addrEl);

        if (i === 0) {
          item.appendChild(priceEl);
          item.appendChild(metaEl);
        } else {
          item.appendChild(priceEl);
          item.appendChild(metaEl);
        }

        listEl.appendChild(item);
      });

      const now = new Date();
      el('time').textContent =
        now.toLocaleDateString('de-AT') + " " +
        now.toLocaleTimeString('de-AT', { hour: '2-digit', minute: '2-digit' });
    }

    function loadStations() {
      showStatus('Lade...');
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          pos => getData(pos.coords.latitude, pos.coords.longitude),
          fallbackLocation,
          { timeout: 3000 }
        );
      } else {
        fallbackLocation();
      }
    }

    function fallbackLocation() {
      showStatus("Linz (Fallback)");
      getData(FALLBACK_LOCATION.latitude, FALLBACK_LOCATION.longitude);
    }

    function getData(lat, lon) {
      const url = `https://api.e-control.at/sprit/1.0/search/gas-stations/by-address?latitude=${lat.toFixed(3)}&longitude=${lon.toFixed(3)}&fuelType=${FUEL_TYPE}&includeClosed=false`;
      fetch(url)
        .then(r => r.json())
        .then(json => {
          showStatus('');
          renderStations(json);
        })
        .catch(err => {
          console.error(err);
          showStatus('Fehler beim Laden');
        });
    }

    loadStations();
  </script>
</body>
</html>