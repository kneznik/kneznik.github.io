<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="js-widget-title" content="Tanken AT">
  <title>Tanken AT</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: transparent;
      font-family: "SF Pro", system-ui, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333333;
    }

    .widget {
      padding: 10px;
      background: transparent;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      max-width: 90%;
      width: auto;
      min-width: 90%;
    }

    .station-main {
      text-align: center;
      margin-bottom: 10px;
    }

    .station-main .price {
      font-family: monospace;
      font-size: 2.5rem;
      font-weight: bold;
    }

    .station-main .name {
      font-weight: 600;
      margin-top: 4px;
      font-size: 1.25rem;
    }

    .station-main .address {
      font-size: 0.875rem;
    }

    .station-list {
      margin-top: 5px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .station {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      gap: 8px;
      cursor: pointer;
    }

    .station .price {
      font-family: monospace;
      font-size: 1rem;
      width: 60px;
      flex-shrink: 0;
    }

    .station .info {
      display: flex;
      flex-direction: column;
    }

    .update-time, .error {
      text-align: center;
      font-size: 0.75rem;
      margin-top: 5px;
    }

    @media (prefers-color-scheme: dark) {
      html, body {
        color: #EEEEEE;
      }
    }
  </style>
</head>

<body>
  <div class="widget">
    <div id="error" class="error" hidden></div>

    <div class="station-main" id="main-station">
      <div class="station clickable" id="main-link">
        <div class="price" id="main-price">--</div>
        <div class="info">
          <div class="name" id="main-name">--</div>
          <div class="address" id="main-address">--</div>
        </div>
      </div>
    </div>

    <div class="station-list">
      <div class="station clickable" id="station-1">
        <div class="price" id="price-1">--</div>
        <div class="info">
          <div class="name" id="name-1">--</div>
          <div class="address" id="address-1">--</div>
        </div>
      </div>

      <div class="station clickable" id="station-2">
        <div class="price" id="price-2">--</div>
        <div class="info">
          <div class="name" id="name-2">--</div>
          <div class="address" id="address-2">--</div>
        </div>
      </div>
    </div>

    <div class="update-time" id="update-time"></div>
  </div>

  <script>
    function __wweb2JsWidgetTitle() {
      return "Tanken AT"; 
    }

    const fuelType = "DIE";

    async function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
          err => reject(err)
        );
      });
    }

    function formatValue(value) {
      if (!value && value !== 0) return "--";
      const str = value.toString();
      const main = str.slice(0, -1);
      const lastDigit = str.slice(-1);
      return `${main}<sup>${lastDigit}€</sup>`;
    }

    async function loadStations() {
      try {
        const location = await getLocation();
        const url = `https://api.e-control.at/sprit/1.0/search/gas-stations/by-address?latitude=${location.latitude.toFixed(3)}&longitude=${location.longitude.toFixed(3)}&fuelType=${fuelType}&includeClosed=false`;
        const res = await fetch(url);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0)
          return { error: true, message: "Keine Tankstellen in der Nähe gefunden." };
        return data;
      } catch {
        return { error: true, message: "Standort oder Daten konnten nicht geladen werden." };
      }
    }

    async function createWidget() {
      const errDiv = document.getElementById("error");
      const main = {
        container: document.getElementById("main-link"),
        price: document.getElementById("main-price"),
        name: document.getElementById("main-name"),
        address: document.getElementById("main-address"),
      };
      const stationsEls = [1, 2].map(i => ({
        container: document.getElementById(`station-${i}`),
        price: document.getElementById(`price-${i}`),
        name: document.getElementById(`name-${i}`),
        address: document.getElementById(`address-${i}`)
      }));
      const timeEl = document.getElementById("update-time");
      const data = await loadStations();

      if (data.error) {
        errDiv.hidden = false;
        errDiv.textContent = data.message;
        return;
      } else {
        errDiv.hidden = true;
      }

      const stations = data.filter(s => Array.isArray(s.prices) && s.prices.length > 0);
      if (!stations.length) {
        errDiv.hidden = false;
        errDiv.textContent = "Keine Tankstellen gefunden.";
        return;
      }

      const top = stations[0];
      const rest = stations.slice(1, 3);

      // Main station – click opens Waze
      main.container.onclick = () => {
        window.location.href = `waze://?ll=${top.location.latitude},${top.location.longitude}&navigate=yes`;
      };
      main.price.innerHTML = formatValue(top.prices[0].amount);
      main.name.textContent = top.name || "Unbekannte Tankstelle";
      main.address.textContent = top.location.address || "Keine Adresse";

      // Other stations
      rest.forEach((st, i) => {
        const el = stationsEls[i];
        el.container.onclick = () => {
          window.location.href = `waze://?ll=${st.location.latitude},${st.location.longitude}&navigate=yes`;
        };
        el.price.innerHTML = formatValue(st.prices[0].amount);
        el.name.textContent = st.name || "Unbekannte Tankstelle";
        el.address.textContent = st.location.address || "Keine Adresse";
      });

      // Hide missing stations
      for (let i = rest.length; i < stationsEls.length; i++) {
        stationsEls[i].container.style.display = "none";
      }

      const now = new Date();
      timeEl.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes()
        .toString().padStart(2, '0')}`;
    }

    createWidget();
  </script>
</body>
</html>