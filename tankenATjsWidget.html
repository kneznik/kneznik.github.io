<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="js-widget-title" content="Tankstellen in der Nähe">
  <title>Tankstellen in der Nähe</title>

  <style>
    :root {
      --bg1: #FFFFFF;
      --bg2: #EEEEEE;
      --text: #000000;
      --text-grey: #555555;
      --shadow: rgba(0,0,0,0.15);
    }

    body {
      font-family: "SF Pro", system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(var(--bg1), var(--bg2));
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      transition: all 0.3s ease;
    }

    .widget {
      width: 800px;
      height: 800px;
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 4px 20px var(--shadow);
      background: linear-gradient(var(--bg1), var(--bg2));
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-sizing: border-box;
    }

    .title {
      text-align: center;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .station-main {
      text-align: center;
      margin-bottom: 20px;
    }

    .station-main .price {
      font-family: monospace;
      font-size: 64px;
      font-weight: bold;
    }

    .station-main .name {
      font-weight: 600;
      margin-top: 6px;
      font-size: 32px;
    }

    .station-main .address {
      font-size: 20px;
      color: var(--text-grey);
    }

    .station-list {
      margin-top: 16px;
    }

    .station {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 20px;
      color: var(--text-grey);
      text-decoration: none;
      padding: 8px 0;
    }

    .station .price {
      font-family: monospace;
      width: 120px;
      font-size: 28px;
    }

    .station .info {
      display: flex;
      flex-direction: column;
    }

    .update-time {
      text-align: center;
      font-size: 16px;
      color: var(--text-grey);
      margin-top: 20px;
    }

    .error {
      text-align: center;
      font-size: 20px;
      color: var(--text-grey);
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="widget">
    <div class="title">⛽ Tankstellen in der Nähe</div>

    <div id="error" class="error" hidden></div>

    <div class="station-main" id="main-station">
      <a id="main-link" href="#action=main">
        <div class="price" id="main-price">--</div>
        <div class="name" id="main-name">Lade Daten...</div>
        <div class="address" id="main-address"></div>
      </a>
    </div>

    <div class="station-list">
      <a class="station" id="station-1" href="#action=station1">
        <div class="price" id="price-1">--</div>
        <div class="info">
          <div class="name" id="name-1"></div>
          <div class="address" id="address-1"></div>
        </div>
      </a>
      <a class="station" id="station-2" href="#action=station2">
        <div class="price" id="price-2">--</div>
        <div class="info">
          <div class="name" id="name-2"></div>
          <div class="address" id="address-2"></div>
        </div>
      </a>
    </div>

    <div class="update-time" id="update-time">--</div>
  </div>

  <script>
    // JS-Widget required functions
    function __wweb2JsWidgetTitle() {
      return "Tankstellen in der Nähe";
    }

    // Allow short delay for async data
    function __wweb2WaitMillisecondsToWidgetIsReady(currentDelayMs) {
      return 1500;
    }

    const fuelType = "DIE";

    async function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
          }),
          err => reject(err)
        );
      });
    }

    function formatValue(value) {
      if (!value && value !== 0) return "--";
      const str = value.toString();
      const main = str.slice(0, -1);
      const lastDigit = str.slice(-1);
      return `${main}${lastDigit.sup()}€`;
    }

    async function loadStations() {
      try {
        const location = await getLocation();
        const url = `https://api.e-control.at/sprit/1.0/search/gas-stations/by-address?latitude=${location.latitude.toFixed(3)}&longitude=${location.longitude.toFixed(3)}&fuelType=${fuelType}&includeClosed=false`;
        const res = await fetch(url);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          return { error: true, message: "Keine Tankstellen in der Nähe gefunden." };
        }
        return data;
      } catch {
        return { error: true, message: "Standort oder Daten konnten nicht geladen werden." };
      }
    }

    async function createWidget() {
      const errDiv = document.getElementById("error");
      const main = {
        link: document.getElementById("main-link"),
        price: document.getElementById("main-price"),
        name: document.getElementById("main-name"),
        address: document.getElementById("main-address"),
      };

      const stationsEls = [1, 2].map(i => ({
        container: document.getElementById(`station-${i}`),
        price: document.getElementById(`price-${i}`),
        name: document.getElementById(`name-${i}`),
        address: document.getElementById(`address-${i}`)
      }));

      const timeEl = document.getElementById("update-time");
      const data = await loadStations();

      if (data.error) {
        errDiv.hidden = false;
        errDiv.textContent = data.message;
        return;
      } else {
        errDiv.hidden = true;
      }

      const stations = data.filter(s => Array.isArray(s.prices) && s.prices.length > 0);
      stations.sort((a, b) => a.prices[0].amount - b.prices[0].amount);

      if (!stations.length) {
        errDiv.hidden = false;
        errDiv.textContent = "Keine gültigen Tankstellen gefunden.";
        return;
      }

      const top = stations[0];
      const rest = stations.slice(1, 3);

      // Haupttankstelle
      main.link.href = `#action=navigate_main&lat=${top.location.latitude}&lng=${top.location.longitude}`;
      main.price.innerHTML = formatValue(top.prices[0].amount);
      main.name.textContent = top.name || "Unbekannte Tankstelle";
      main.address.textContent = top.location.address || "Keine Adresse";

      // Weitere Tankstellen
      rest.forEach((st, i) => {
        const el = stationsEls[i];
        el.container.href = `#action=navigate_${i}&lat=${st.location.latitude}&lng=${st.location.longitude}`;
        el.price.innerHTML = formatValue(st.prices[0].amount);
        el.name.textContent = st.name || "Unbekannte Tankstelle";
        el.address.textContent = st.location.address || "Keine Adresse";
      });

      for (let i = rest.length; i < stationsEls.length; i++) {
        stationsEls[i].container.style.display = "none";
      }

      timeEl.textContent = "Stand: " + new Date().toLocaleString();
    }

    // Process widget action when user taps
    function handleAction() {
      let queryString = window.location.hash;
      if (queryString.startsWith("#")) queryString = queryString.substring(1);
      const urlParams = new URLSearchParams(queryString);
      const action = urlParams.get("action");
      const lat = urlParams.get("lat");
      const lng = urlParams.get("lng");

      if (action && lat && lng && action.startsWith("navigate")) {
        window.location.href = `waze://?ll=${lat},${lng}&navigate=yes`;
      }
    }

    handleAction();
    createWidget();
  </script>
</body>
</html>